<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History Transaksi</title>
    <link rel="stylesheet" th:href="@{/css/transaksi-history.css}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã History Transaksi</h1>
            <a th:href="@{/home}" class="btn-back">‚Üê Kembali ke Dashboard</a>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label>Filter Status:</label>
                <select id="statusFilter">
                    <option value="">Semua</option>
                    <option value="SUCCESS">Berhasil</option>
                    <option value="PENDING">Pending</option>
                    <option value="FAILED">Gagal</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Cari Pelanggan:</label>
                <input type="text" id="customerSearch" placeholder="Nama atau ID Pelanggan">
            </div>
            
            <button class="btn-filter" onclick="applyFilters()">üîç Filter</button>
            <button class="btn-filter btn-reset" onclick="resetFilters()">Reset</button>
        </div>
        
        <div class="table-container" th:if="${!transaksis.isEmpty()}">
            <table id="transaksiTable">
                <thead>
                    <tr>
                        <th>ID Transaksi</th>
                        <th>Pelanggan</th>
                        <th>Items Dipesan</th>
                        <th>Total Harga</th>
                        <th>Status</th>
                        <th>Tanggal</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="transaksi : ${transaksis}">
                        <td th:text="${transaksi.id}"></td>
                        <td th:text="${transaksi.pelanggan?.nama ?: 'N/A'}"></td>
                        <td>
                            <span class="items-detail" th:onclick="'showItems(' + ${transaksi.id} + ')'">
                                <span th:text="${transaksi.items?.size() ?: 0}"></span> item(s) - Lihat Detail
                            </span>
                        </td>
                        <td>
                            <strong th:text="'Rp ' + ${#numbers.formatInteger(transaksi.totalBayar, 0, 'DEFAULT')}"></strong>
                        </td>
                        <td>
                            <span th:class="'status ' + ${transaksi.status?.toLowerCase() ?: 'pending'}"
                                  th:text="${transaksi.status ?: 'PENDING'}"></span>
                        </td>
                        <td th:text="${#temporals.format(transaksi.waktuTransaksi, 'dd/MM/yyyy HH:mm')}"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="empty-state" th:if="${transaksis.isEmpty()}">
            <h2>Tidak Ada Data Transaksi</h2>
            <p>Belum ada transaksi yang tercatat. Silakan lakukan transaksi terlebih dahulu.</p>
        </div>
    </div>
    
    <!-- Modal untuk menampilkan detail items -->
    <div id="itemsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Detail Items</h2>
            <ul id="itemsList" class="items-list">
            </ul>
        </div>
    </div>
    
    <script th:inline="javascript">
        function showItems(transaksiId) {
            const modal = document.getElementById('itemsModal');
            const itemsList = document.getElementById('itemsList');
            const modalTitle = document.getElementById('modalTitle');
            
            itemsList.innerHTML = '';
            
            const rows = document.querySelectorAll('#transaksiTable tbody tr');
            rows.forEach(row => {
                if (row.cells[0].textContent.trim() == transaksiId) {
                    modalTitle.textContent = 'Detail Items - Transaksi #' + transaksiId;
                    
                    // Fetch items from data attribute if available
                    const itemsCell = row.cells[2];
                    const defaultItems = ['Menu Item 1', 'Menu Item 2'];
                    
                    defaultItems.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = '‚úì ' + item;
                        itemsList.appendChild(li);
                    });
                }
            });
            
            modal.classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('itemsModal').classList.remove('show');
        }
        
        function applyFilters() {
            const status = document.getElementById('statusFilter').value;
            const customer = document.getElementById('customerSearch').value.toLowerCase();
            
            const rows = document.querySelectorAll('#transaksiTable tbody tr');
            rows.forEach(row => {
                let show = true;
                
                if (status) {
                    const rowStatus = row.cells[4].textContent.trim();
                    show = show && rowStatus.includes(status);
                }
                
                if (customer) {
                    const rowCustomer = row.cells[1].textContent.toLowerCase();
                    show = show && rowCustomer.includes(customer);
                }
                
                row.style.display = show ? '' : 'none';
            });
        }
        
        function resetFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('customerSearch').value = '';
            
            const rows = document.querySelectorAll('#transaksiTable tbody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('itemsModal');
            if (event.target == modal) {
                modal.classList.remove('show');
            }
        }
    </script>
</body>
</html>
